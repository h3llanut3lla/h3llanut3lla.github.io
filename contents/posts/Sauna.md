---
title: "Sauna"
date: 2025-02-09
update: 2025-02-09
tags:
  - HTB
  - ASREPRoasting
  - PtH
  - DCSync
  - ìœˆë„ìš°ì¦ˆ
---
## Sauna ìš”ì•½
![](https://velog.velcdn.com/images/h3llanut3lla/post/4a06e187-1d98-4268-9540-f1c4a459e2df/image.png)

> ðŸŒŸ **í•œ ì¤„ í‰**
>
> ì•¡í‹°ë¸Œ ë””ë ‰í† ë¦¬ì˜ ê¸°ë³¸ì ì¸ ê³µê²© ìš”ì†Œ ë° ì •ë³´ ìˆ˜ì§‘ ë°©ë²•ë“¤ì„ ê²½í—˜í•  ìˆ˜ ìžˆëŠ” ì‹œìŠ¤í…œì¸ë°, ìž˜ ë§Œë“¤ì—ˆë‹¤ê³  ì†Œë¬¸ë‚œ Pro Labsì˜ Danteë¥¼ ë§Œë“  ì œìž‘ìž (egotisticalSW)ê°€ ë§Œë“  ì‹œìŠ¤í…œì´ë¼ ê·¸ëŸ°ì§€ í•µë”ë°•ìŠ¤ë‚´ì—ì„œë„ ì¸ê¸°ê°€ ë†’ë‹¤. 

ì‚¬ìš°ë‚˜ëŠ” Active Directory ì—´ê±° ë° í™œìš© ê¸°ëŠ¥ì„ ê°–ì¶˜ ì‰¬ìš´ ë‚œì´ë„ì˜ ìœˆë„ìš°ì¦ˆ ì‹œìŠ¤í…œì´ë‹¤. 

ì›¹ì‚¬ì´íŠ¸ì— ë‚˜ì™€ ìžˆëŠ” ì§ì› ì´ë¦„ì„ í™œìš©í•˜ì—¬ ì‚¬ìš©ìž ì´ë¦„ ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ ASREPRoasting ê³µê²©ì— ì‚¬ìš©í•˜ë©´ ì»¬ë¸Œë¡œìŠ¤ ì‚¬ì „ ì¸ì¦ (Kerberos pre-authentication)ì´ í•„ìš”í•˜ì§€ ì•Šì€ ê³„ì •ì— ëŒ€í•œ í•´ì‹œë¥¼ ì–»ì„ ìˆ˜ ìžˆë‹¤. ì´ í•´ì‹œë¥¼ ì´ìš©í•˜ì—¬ ì˜¤í”„ë¼ì¸ ë¬´ì°¨ë³„ ëŒ€ìž… ê³µê²© (Offline brute force attack)ì„ ìˆ˜í–‰ í•˜ê²Œ ë˜ë©´ WinRMì„ ì‹¤í–‰ í•  ìˆ˜ ìžˆëŠ” ì‚¬ìš©ìž ê³„ì •ì˜ ì¼ë°˜ í…ìŠ¤íŠ¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì–»ì„ ìˆ˜ ìžˆë‹¤. 

ê¶Œí•œìƒìŠ¹ì„ ìœ„í•œ ì •ë³´ ìˆ˜ì§‘ìœ¼ë¡œ WinPEASë¥¼ ì‹¤í–‰í•˜ë©´ ë‹¤ë¥¸ ì‹œìŠ¤í…œ ì‚¬ìš©ìžê°€ ìžë™ ë¡œê·¸ì¸ ì„¤ì •ì„ í•´ë‘ì—ˆë‹¤ëŠ” ì‚¬ì‹¤ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•¨ê»˜ í™•ì¸ í•  ìˆ˜ ìžˆë‹¤. ë¸”ëŸ¬ë“œí•˜ìš´ë“œ (BloodHound)ë¥¼ ì´ìš©í•˜ë©´ ì´ ì‚¬ìš©ìžì—ê²ŒëŠ” ë””ì”¨ì”½í¬ (DCSync) ê³µê²© ì‹œ ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì•”í˜¸ í•´ì‹œë¥¼ ë¤í”„í•  ìˆ˜ ìžˆëŠ” `DS-Replication-Get-Changes-All` í™•ìž¥ ê¶Œí•œì´ ìžˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìžˆë‹¤. ì´ ê³µê²©ì„ ì‹¤í–‰í•˜ë©´ ì£¼ ë„ë©”ì¸ ê´€ë¦¬ìžì˜ í•´ì‰¬ë¥¼ ì–»ì„ ìˆ˜ ìžˆìœ¼ë©° ì´ëŠ” ìž„íŒ¨í‚· (Impacket)ì˜ í”¼ì—ìŠ¤ì´ê·¸ì  (psexec.py)ê³¼ í•¨ê»˜ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ìƒìŠ¹ëœ ê¶Œí•œì¸ `NT_AUTHORITY\SYSTEM` ìœ¼ë¡œì¨ ì‰˜ì„ ì—´ ìˆ˜ ìžˆë‹¤. 

## ì •ë³´ ìˆ˜ì§‘
### Nmap í¬íŠ¸ ìŠ¤ìº”
```sh
PORT      STATE SERVICE                    
53/tcp    open  domain 
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds                          
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP              
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
49667/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
49671/tcp open  unknown
49681/tcp open  unknown
64471/tcp open  unknown
```
- ë””ë ‰í† ë¦¬ í¼ì§• (Directory Fuzzing) ì—ì„œëŠ” ë”±ížˆ ëˆˆì— ë„ëŠ” í´ë”ëŠ” ì—†ì—ˆë‹¤. 
- LDAPì„ ì—´ê±°í•˜ë©´ ë„ë©”ì¸ëª… `egotistical-bank.local` ì„ í™•ì¸ í•  ìˆ˜ ìžˆë‹¤. 

### 80-HTTP
`http://egotistical-bank.local/about.html` ë¡œ ì ‘ì†í•˜ë©´ ì§ì›ë“¤ì˜ ì´ë¦„ì„ í™•ì¸í•  ìˆ˜ ìžˆë‹¤. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/be597dbd-270e-439f-9379-9d46daf99b85/image.png)

### ìœ ì €ë„¤ìž„ ì–»ê¸°
ë‚˜ì¤‘ì— ì°¾ì•„ë³´ë‹ˆ [Kerbrute](https://github.com/ropnop/kerbrute)ë¥¼ í™œìš©í•´ ì¢€ ë” ê°„ê²°í•˜ê³  ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ì‚¬ìš©ìžëª…ì„ ì–»ëŠ” ë°©ë²•ì´ ìžˆìœ¼ë‚˜ ë‚˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì–»ì—ˆë‹¤.

>Kerbruteë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ì€ [ì´ ë¬¸ì œí’€ì´](https://0xdf.gitlab.io/2020/07/18/htb-sauna.html#recon) ì°¸ì¡°. 

[Username anarchy](https://github.com/urbanadventurer/username-anarchy)ë¥¼ ì´ìš©í•˜ì—¬ ì§ì›ë“¤ì˜ í’€ë„¤ìž„ì„ ë„£ìœ¼ë©´ ê·¸ê±¸ ì¹˜í™˜í•´ ìœ ì €ë„¤ìž„ í˜•ì‹ìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ”ë° ë‹¤ì–‘í•œ í˜•ì‹ì˜ ìœ ì €ë„¤ìž„ ë¦¬ìŠ¤íŠ¸ë¥¼ ASREPRoasting ê³µê²©ì— ë„£ì–´ ì–»ì–´ ê±¸ë¦¬ê¸¸ ê¸°ë„í•˜ëŠ” ë°©ë²•ì´ë‹¤. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/88c244c4-5d61-4be2-8646-8c54a7caf1cc/image.png)

## ASREPRoasting / í•´ì‹œ ì–»ê¸°
### ASREPRoating ê°œë…
êµ¬ê¸€ë§ì„ í•˜ë‹¤ë³´ë©´ ê¸€ì´ ê¸¸ê³  ì„¤ëª…ì´ ë³µìž¡í•œê²ƒë“¤ì´ ëŒ€ë¶€ë¶„ì¸ë°, [ì´ í¬ìŠ¤íŠ¸](https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html#as-rep-roasting)ê°€ ê°„ê²°í•˜ê³  ì‰½ê²Œ ìž˜ ì„¤ëª…í•œ ê²ƒ ê°™ë‹¤. 

ìœ„ í¬ìŠ¤íŠ¸ë¥¼ ìš”ì•½í•˜ìžë©´, 
- ì‚¬ì „ ì¸ì¦ì€ Kerberos ì¸ì¦ì˜ ì²« ë²ˆì§¸ ë‹¨ê³„ì´ë©° ì£¼ìš” ì—­í• ì€ ë¬´ì°¨ë³„ ì•”í˜¸ ì¶”ì¸¡ ê³µê²©ì„ ë°©ì§€í•˜ëŠ” ê²ƒìž„. 
- ì‚¬ì „ ì¸ì¦ ì ˆì°¨ ì¤‘, ì‚¬ìš©ìžëŠ” íƒ€ìž„ìŠ¤íƒ¬í”„ë¥¼ ì•”í˜¸í™”í•˜ëŠ”ë° ì‚¬ìš©í•  ìžê²©ì¦ëª…ì„ ìž…ë ¥í•¨. 
- DCëŠ” ì´ë¥¼ í•´ë…í•˜ì—¬ ì˜¬ë°”ë¥¸ ìžê²© ì¦ëª…ì´ ì‚¬ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•¨. 
- DCê°€ ìŠ¹ì¸í•˜ë©´ TGTë¥¼ ë°œí–‰.
- ì‚¬ì „ ì¸ì¦ì´ ë¹„í™œì„±í™”ë˜ë©´ ê³µê²©ìžê°€ _ëª¨ë“  _ì‚¬ìš©ìžì— ëŒ€í•œ í‹°ì¼“ì„ ìš”ì²­í•  ìˆ˜ ìžˆìŒ.
- ë”°ë¼ì„œ ëª…ì‹œì ìœ¼ë¡œ ê³„ì •ì— `DONT_REQ_PREAUTH` (ì‚¬ì „ ì¸ì¦ ë¹„í™œì„±í™”) ë¼ëŠ” ì„¤ì •ì´ ìžˆì–´ì•¼ ê°€ëŠ¥í•œ ê³µê²©ìž„. 
- ê·¸ëŸ¼ DCëŠ” ì˜¤í”„ë¼ì¸ì—ì„œ í¬ëž™í•  ìˆ˜ ìžˆëŠ” Kerberoast ê³µê²©ê³¼ ìœ ì‚¬í•˜ê²Œ ì•”í˜¸í™”ëœ TGTë¥¼ ë°˜í™˜í•¨. 

ìš°ì„  ì»¬ë¸Œë¡œìŠ¤ 88ë²ˆ í¬íŠ¸ê°€ ì—´ë ¤ ìžˆê³ , ìœˆë„ìš°ì¦ˆ ì‹œìŠ¤í…œì´ê³ , ì‚¬ì „ì¸ì¦ì´ ë¹„í™œì„±í™”ëœ ê³„ì •ì´ ìžˆë‹¤ë©´ ì‹œë„í•´ë³¼ë§Œ í•œ ê³µê²©ì¸ ê²ƒ ê°™ë‹¤. 

### ASREPRoasting ì‹œë„
ì•„ëž˜ì˜ ëª…ë ¹ì–´ë¥¼ ìž…ë ¥í•´ ìœ„ì—ì„œ ë§Œë“  ìœ ì €ë„¤ìž„ ë¦¬ìŠ¤íŠ¸ë¥¼ ë„£ì–´ Impacketì˜ GetNPUsersë¥¼ ì‚¬ìš©í•´ ASREPRoasting ê³µê²©ì„ ì‹¤í–‰, ì•„ì›ƒí’‹ìœ¼ë¡œ ë‚˜ì˜¨ í•´ì‹œë¥¼ `hash.txt` íŒŒì¼ì— ì €ìž¥í•œë‹¤. 

```sh
while read p; do impacket-GetNPUsers egotistical-bank.local/"$p" -request -no-pass -dc-ip 10.10.10.175 >> hash.txt; done < unames.txt
```

ê·¸ëŸ¬ë©´ ì•„ëž˜ì™€ ê°™ì´ `fsmith` ì‚¬ìš©ìžì˜ ì»¬ë¸Œë¡œìŠ¤ í•´ì‰¬ë¥¼ ì–»ì„ ìˆ˜ ìžˆë‹¤. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/55f4b870-d498-48b7-969a-6d4cd964d98a/image.png)

ì¼ë°˜ í…ìŠ¤íŠ¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì–»ê¸° ìœ„í•´ í•´ì‰¬ìº£ì„ ì´ìš©í•´ ë¬´ì°¨ë³„ ëŒ€ìž…ì„ í•˜ë©´ ëœë‹¤. 

```sh
hashcat -m 18200 fsmithhash /usr/share/wordlists/rockyou.txt --force
```

í•´ì‰¬ìº£ ëª¨ë“œëŠ” `hashcat --help | grep Kerberos`ë¥¼ ìž…ë ¥í•´, `AS-REP` ì´ë¼ê³  ì ížŒ ëª¨ë“œ ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•œë‹¤. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/78b5413e-a491-483c-8936-f1744512efba/image.png)

ê·¸ëŸ¬ë©´ ì´ë ‡ê²Œ í¬ëž™ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì–»ì„ ìˆ˜ ìžˆë‹¤. 

- ìœ ì €ë„¤ìž„: `fsmith`
- ë¹„ë°€ë²ˆí˜¸: `Thestrokes23`


## ì´ˆìž…
Evil-WinRMì„ ì´ìš©í•˜ì—¬ ìƒˆë¡œ ì–»ì€ ë¡œê·¸ì¸ ìžê²©ì¦ëª…ì„ ë„£ìœ¼ë©´ ì´ˆìž…ì— ì„±ê³µí•  ìˆ˜ ìžˆë‹¤. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/43b2d8fa-fe29-411c-97df-7fd457d3aebf/image.png)

## ê¶Œí•œìƒìŠ¹
### ì •ë³´ ìˆ˜ì§‘
[WinPEAS](https://github.com/peass-ng/PEASS-ng/blob/master/winPEAS/winPEASexe/README.md)ë¥¼ ì‹¤í–‰í•˜ë©´ ì•„ëž˜ì™€ ê°™ì´ ìžë™ë¡œê·¸ì¸ì´ í™œì„±í™”ëœ ê³„ì •ì •ë³´ë¥¼ ë¹„ë°€ë²ˆí˜¸ì™€ í•¨ê»˜ ì–»ì„ ìˆ˜ ìžˆë‹¤. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/7143ac67-0377-4a57-b206-1d392687d4c0/image.png)

- ìœ ì €ë„¤ìž„: `svc_loanmanager`
- ë¹„ë°€ë²ˆí˜¸: `Moneymakestheworldgoround!`

### ì‹œë„ 
ì´ˆìž… ë°©ì‹ì™€ ê°™ì´ ìƒˆë¡œ ì–»ì€ ìžê²©ì¦ëª…ì„ í™œìš©í•´ Evil WinRMì„ í†µí•´ ì—°ê²°í•´ë³´ìž. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/779305e0-89f4-430f-a9bf-9435496ee062/image.png)

## ë¸”ëŸ¬ë“œí•˜ìš´ë“œ (BloodHound)
[ë¸”ëŸ¬ë“œí•˜ìš´ë“œ](https://github.com/SpecterOps/BloodHound-Legacy)ë¥¼ ì‚¬ìš©í•˜ë©´ ì•¡í‹°ë¸Œë””ë ‰í† ë¦¬ ë„ë©”ì¸ ì—´ê±° ë° ì‹œê°í™”ë¥¼ í•  ìˆ˜ ìžˆëŠ”ë° ê¶Œí•œìƒìŠ¹ì„ ìœ„í•œ ì •ë³´ ìˆ˜ì§‘ì‹œ ê°€ì´ë“œ ì—­í• ì„ í•´ì£¼ëŠ” ì•„ì£¼ ìœ ìš©í•œ íˆ´ì´ë‹¤. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/ee48adf9-5457-41dc-af91-e94e39c5235f/image.png)

`Queries` íƒ­ì—ì„œ `Find Principals with DCSync Rights` ë¥¼ í´ë¦­í•˜ë©´ í˜„ ì‚¬ìš©ìžê°€ `GetChangesAll`ì„ í†µí•´ ë„ë©”ì¸ê³¼ ì—°ê²°ì´ ëœ ê²ƒì„ ë³¼ ìˆ˜ ìžˆë‹¤.

ê°€ìž¥ìžë¦¬ë¥¼ ìš°í´ë¦­í•˜ê³  `Help`ë¥¼ í´ë¦­í•˜ë©´ svc_loanmgr(í˜„ ì‚¬ìš©ìž)ê°€ DCSync ê³µê²©ì„ ì‚¬ìš©í•˜ì—¬ ë„ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œë¥¼ ë¤í”„í•  ìˆ˜ ìžˆìŒì„ ì•Œ ìˆ˜ ìžˆë‹¤.

![](https://velog.velcdn.com/images/h3llanut3lla/post/63046407-49dc-4d39-828d-1a0461df8a88/image.png)

## ë””ì”¨ì”½í¬ (DCSync)
![](https://velog.velcdn.com/images/h3llanut3lla/post/8682c72b-2a15-43ad-984b-c520fd415b15/image.png)

ì´ë ‡ê²Œ í•˜ë©´ ê´€ë¦¬ìžì˜ í•´ì‰¬ë¥¼ ì–»ì„ ìˆ˜ ìžˆë‹¤. 
ì´ ë°©ë²• ì™¸ì—ë„ ë¯¸ë¯¸ì¼“ì¦ˆ (Mimikatz)ë¥¼ íƒ€ê²Ÿì—ì„œ ì‹¤í–‰í•´ ê´€ë¦¬ìž í•´ì‰¬ë¥¼ ì–»ëŠ” ë°©ë²•, ë””ì”¨ì”½í¬ë¥¼ í†µí•´ ì–»ì€ í•´ì‰¬ë¥¼ Evil-WinRMì— ê·¸ëŒ€ë¡œ ë„£ì–´ ê´€ë¦¬ìžë¡œì¨ ì—°ê²°í•˜ëŠ” ë°©ë²•ì´ ìžˆë‹¤ê³  í•œë‹¤. 

## íŒ¨ìŠ¤ë”í•´ì‹œ (PtH)
ë‚˜ëŠ” í•´ì‰¬ë¥¼ ìž„íŒ¨ì¼“ (Impacket) í”¼ì—ìŠ¤ì´ê·¸ì  (psexec.py)ì— ë„£ì–´ íŒ¨ìŠ¤í•˜ëŠ” ë°©ë²•ì„ íƒí–ˆë‹¤. 

![](https://velog.velcdn.com/images/h3llanut3lla/post/bb50f669-d675-4dc1-b889-b7e982d0b215/image.png)
